<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PressKart — In‑Chat App</title>
  <style>
    :root{--bg:#f7f7fb;--fg:#0f172a;--muted:#6b7280;--brand1:#f97316;--brand2:#2563eb;--card:#ffffff;--border:#e5e7eb}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    h1,h2,h3{margin:0 0 .5rem} h3{font-size:1.05rem}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .header{display:flex;align-items:center;justify-content:space-between;padding:16px 0}
    .logo{display:flex;align-items:center;gap:10px}
    .logo-badge{width:40px;height:40px;border-radius:12px;background:var(--brand1);color:white;display:grid;place-items:center;font-weight:800}
    .logo-title{line-height:1}
    .logo-title .press{color:var(--brand1);font-weight:800}
    .logo-title .kart{color:var(--brand2);font-weight:800}
    .tag{display:inline-block;background:#fee2e2;color:#b91c1c;padding:2px 8px;border-radius:999px;font-size:12px}
    .pill{display:inline-block;background:#fff3e8;color:#7c2d12;padding:3px 10px;border:1px solid #fcd9bd;border-radius:999px;font-size:12px}
    .btn{border:1px solid var(--border);background:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:#111827;color:#fff;border-color:#111827}
    .btn.ghost{background:transparent}
    .btn.danger{background:#ef4444;border-color:#ef4444;color:#fff}
    .btn.accent{background:var(--brand1);border-color:var(--brand1);color:#fff}
    .grid{display:grid;gap:16px}
    .col-2{grid-template-columns:1fr 1fr}
    .col-3{grid-template-columns:repeat(3,1fr)}
    .col-4{grid-template-columns:repeat(4,1fr)}
    @media(min-width:880px){.layout{grid-template-columns:2fr 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden}
    .card-h{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:#f3f4f6;border-bottom:1px solid var(--border)}
    .card-b{padding:16px}
    label{display:block;margin-bottom:8px;color:#374151;font-size:13px}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px}
    .row{display:grid;gap:12px}
    .row-12{grid-template-columns:3fr 1fr 2fr 2fr 1fr}
    .small{font-size:12px;color:var(--muted)}
    .flex{display:flex;gap:8px;align-items:center}
    .between{justify-content:space-between}
    .right{text-align:right}
    .nowrap{white-space:nowrap}
    .list{display:grid;gap:12px;margin:0;padding:0;list-style:none}
    .border{border-top:1px solid var(--border);margin:8px 0 0;padding-top:8px}
    .dot{width:8px;height:8px;border-radius:999px;display:inline-block}
    .green{background:#10b981}.red{background:#ef4444}.gray{background:#9ca3af}
    .status{padding:2px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px}
    .money{font-variant-numeric:tabular-nums}
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="logo">
        <div class="logo-badge">PK</div>
        <div class="logo-title">
          <div><span class="press">Press</span><span class="kart">Kart</span></div>
          <div class="small">Pickup • Press • Deliver</div>
        </div>
      </div>
      <div id="walletPill" class="pill">Wallet: RM 0.00</div>
    </header>

    <main class="grid layout">
      <section class="grid" style="gap:20px">
        <div class="card">
          <div class="card-h">
            <h3>Profile</h3>
            <button class="btn ghost" id="saveProfileBtn">Save</button>
          </div>
          <div class="card-b grid col-2">
            <div>
              <label>Full Name</label>
              <input id="name" placeholder="e.g., Aina Binti Ali" />
            </div>
            <div>
              <label>Phone</label>
              <input id="phone" placeholder="e.g., +60 12-345 6789" />
            </div>
            <div class="col" style="grid-column:1/-1">
              <label>Address</label>
              <input id="address" placeholder="Street, City" />
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-h between">
            <h3>Place an Order</h3>
            <span class="small">Live price + delivery</span>
          </div>
          <div class="card-b grid" style="gap:14px">
            <div>
              <label>Pickup Slot</label>
              <select id="slot"></select>
            </div>

            <div>
              <div class="flex between"><label>Laundry Items</label><button class="btn ghost" id="addRow">+ Add Item</button></div>
              <div id="items"></div>
            </div>

            <div class="grid col-3">
              <div>
                <label>Delivery Category</label>
                <select id="delivery"></select>
              </div>
              <div>
                <label>Payment</label>
                <select id="payment">
                  <option>Wallet</option>
                  <option>Online</option>
                  <option>Card</option>
                </select>
              </div>
              <div>
                <label>Notes</label>
                <input id="notes" placeholder="Gate code, fabric notes, etc." />
              </div>
            </div>

            <div>
              <div class="flex between"><span>Items total</span><b class="money" id="itemsTotal">RM 0.00</b></div>
              <div class="flex between"><span>Delivery</span><b class="money" id="deliveryCost">RM 0.00</b></div>
              <div class="flex between border"><span><b>Grand Total</b></span><span class="money" id="grandTotal"><b>RM 0.00</b></span></div>
            </div>

            <div class="flex">
              <button class="btn accent" id="placeOrder">Place Order</button>
              <button class="btn ghost" id="resetForm">Reset</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-h"><h3>Your Orders</h3></div>
          <div class="card-b">
            <ul id="orders" class="list"></ul>
          </div>
        </div>
      </section>

      <aside class="grid" style="gap:20px">
        <div class="card">
          <div class="card-h"><h3>Wallet</h3></div>
          <div class="card-b">
            <div class="flex between">
              <div>Balance: <b class="money" id="walletBalance">RM 0.00</b></div>
              <div class="flex">
                <input id="topupAmt" type="number" min="1" value="20" style="width:110px" />
                <button class="btn accent" id="topupBtn">Top up</button>
              </div>
            </div>
            <div class="flex" style="margin-top:8px;flex-wrap:wrap">
              <button class="btn" data-topup="10">+ RM 10</button>
              <button class="btn" data-topup="20">+ RM 20</button>
              <button class="btn" data-topup="50">+ RM 50</button>
              <button class="btn" data-topup="100">+ RM 100</button>
              <button class="btn ghost" id="resetWallet">Reset</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-h"><h3>How it works</h3></div>
          <div class="card-b small">
            <ol style="margin:0 0 0 18px;display:grid;gap:8px">
              <li>Save your profile.</li>
              <li>Add items (Wash / Iron), choose delivery.</li>
              <li>Pay (Wallet / Online / Card). Wallet deducts immediately.</li>
              <li>Track status with per‑stage EAT.</li>
            </ol>
          </div>
        </div>
      </aside>
    </main>

    <footer class="small" style="text-align:center;color:var(--muted);padding:24px 0">© <span id="year"></span> PressKart (Prototype)</footer>
  </div>

<script>
(function(){
  // ---------- Constants ----------
  const ITEM_OPTIONS = ["Shirt","Pant","Bedsheet","Dress","Towel"];
  const PRICE_TABLE = {Shirt:{wash:3,iron:2},Pant:{wash:4,iron:2},Bedsheet:{wash:8,iron:5},Dress:{wash:6,iron:3},Towel:{wash:5,iron:0}};
  const DELIVERY = {Saver:{label:"Saver",cost:4,minutes:120}, Standard:{label:"Standard",cost:7,minutes:90}, Priority:{label:"Priority",cost:12,minutes:60}};
  const STATUSES = ["Scheduled","Picked","Cleaning","Ready","Delivered"];
  const WORKFLOW = {scheduled_to_picked:30, picked_to_cleaning:15, cleaning_to_ready:60};

  // ---------- Storage helpers ----------
  const LS = {USER:'pk_user', WALLET:'pk_wallet', ORDERS:'pk_orders'};
  const load = (k, fb) => {try{const v = localStorage.getItem(k); return v? JSON.parse(v): fb;}catch{return fb}};
  const save = (k,v) => localStorage.setItem(k, JSON.stringify(v));

  // ---------- State ----------
  let user = load(LS.USER, null);
  let wallet = {balance: Number(load(LS.WALLET, 0)) || 0};
  let orders = load(LS.ORDERS, []);

  // ---------- Utils ----------
  const uid = () => Math.random().toString(36).slice(2,10);
  const fmt = n => `RM ${Number(n||0).toFixed(2)}`;
  const nowIso = () => new Date().toISOString();
  function formatDuration(ms){ if(ms==null) return null; if(ms<=0) return '0m'; const s=Math.ceil(ms/1000); const h=Math.floor(s/3600); const m=Math.floor((s%3600)/60); const ss=s%60; if(h>0) return `${h}h ${m}m`; if(m>0) return `${m}m ${ss}s`; return `${ss}s`; }
  function buildEat(createdIso, deliveryKey){
    const base = new Date(createdIso).getTime();
    const picked = base + WORKFLOW.scheduled_to_picked*60000;
    const cleaning = picked + WORKFLOW.picked_to_cleaning*60000;
    const ready = cleaning + WORKFLOW.cleaning_to_ready*60000;
    const lastLeg = (DELIVERY[deliveryKey]||DELIVERY.Saver).minutes*60000;
    return {Picked:new Date(picked).toISOString(), Cleaning:new Date(cleaning).toISOString(), Ready:new Date(ready).toISOString(), Delivered:new Date(ready+lastLeg).toISOString()};
  }
  function calcItems(items){
    let total=0; items.forEach(it=>{const p=PRICE_TABLE[it.type]; const per=(it.wash?p.wash:0)+(it.iron?p.iron:0); total += per*(it.count||0)}); return total;
  }

  // ---------- DOM refs ----------
  const yearEl = document.getElementById('year'); yearEl.textContent = new Date().getFullYear();
  const nameEl = document.getElementById('name');
  const phoneEl = document.getElementById('phone');
  const addressEl = document.getElementById('address');
  const saveProfileBtn = document.getElementById('saveProfileBtn');
  const walletPill = document.getElementById('walletPill');
  const walletBal = document.getElementById('walletBalance');
  const topupAmt = document.getElementById('topupAmt');
  const topupBtn = document.getElementById('topupBtn');
  const resetWalletBtn = document.getElementById('resetWallet');
  const slotSel = document.getElementById('slot');
  const itemsEl = document.getElementById('items');
  const addRowBtn = document.getElementById('addRow');
  const deliverySel = document.getElementById('delivery');
  const paymentSel = document.getElementById('payment');
  const notesEl = document.getElementById('notes');
  const itemsTotalEl = document.getElementById('itemsTotal');
  const deliveryCostEl = document.getElementById('deliveryCost');
  const grandTotalEl = document.getElementById('grandTotal');
  const placeBtn = document.getElementById('placeOrder');
  const resetFormBtn = document.getElementById('resetForm');
  const ordersEl = document.getElementById('orders');

  // ---------- Init profile ----------
  function renderWallet(){ walletPill.textContent = `Wallet: ${fmt(wallet.balance)}`; walletBal.textContent = fmt(wallet.balance); save(LS.WALLET, wallet.balance); }
  function renderProfile(){ if(user){ nameEl.value=user.name; phoneEl.value=user.phone; addressEl.value=user.address; } }
  renderProfile(); renderWallet();

  saveProfileBtn.onclick = () => {
    const name = nameEl.value.trim(), phone = phoneEl.value.trim(), address = addressEl.value.trim();
    if(!name||!phone||!address){ alert('Please fill all fields.'); return; }
    user = { id: user?.id || uid(), name, phone, address };
    save(LS.USER, user); alert('Profile saved');
    if(orders.length===0){ // seed demo order
      const created = nowIso();
      const demo = { id: uid(), userId:user.id, lineItems:[{id:uid(),type:'Shirt',count:3,wash:true,iron:false}], notes:'Ring bell', slot: new Date().toISOString().slice(0,10)+" 12:00–14:00", status:'Scheduled', createdAt:created, updatedAt:created, summary:'3 Shirts (wash)', itemsTotal:9, deliveryType:'Saver', deliveryCost:4, estimateMYR:13, logs:[{status:'Scheduled',at:created}], paymentMethod:'Wallet', paymentStatus:'Paid (Wallet)', eat: buildEat(created,'Saver') };
      orders=[demo]; save(LS.ORDERS, orders); renderOrders();
    }
  };

  // ---------- Slots & Delivery ----------
  (function buildSlots(){
    const out=[]; const base=new Date();
    for(let d=0; d<3; d++){ const day=new Date(base); day.setDate(base.getDate()+d); const ds=day.toISOString().slice(0,10); ["10:00–12:00","12:00–14:00","16:00–18:00"].forEach(r=>out.push(`${ds} ${r}`)); }
    out.forEach(s=>{ const o=document.createElement('option'); o.textContent=s; slotSel.appendChild(o); });
  })();
  (function buildDelivery(){ Object.keys(DELIVERY).forEach(k=>{ const opt=document.createElement('option'); const v=DELIVERY[k]; opt.value=k; opt.textContent=`${v.label} — ${fmt(v.cost)} / ~${(v.minutes/60).toFixed(2)}h`; deliverySel.appendChild(opt); }); })();

  // ---------- Items UI ----------
  function itemRowTemplate(id, def){
    const row=document.createElement('div'); row.className='row row-12'; row.dataset.id=id;
    row.innerHTML = `
      <div>
        <select name="type" data-k="type">${ITEM_OPTIONS.map(o=>`<option ${def.type===o?'selected':''}>${o}</option>`).join('')}</select>
      </div>
      <div><input type="number" min="0" value="${def.count}" data-k="count"/></div>
      <div class="flex" style="gap:12px">
        <label class="flex"><input type="checkbox" ${def.wash?'checked':''} data-k="wash"/> <span class="small" style="margin-left:6px">Wash</span></label>
        <label class="flex"><input type="checkbox" ${def.iron?'checked':''} data-k="iron"/> <span class="small" style="margin-left:6px">Iron</span></label>
      </div>
      <div class="right nowrap small">Per‑unit: <span class="money" data-k="per"></span> <span class="small">/ unit</span></div>
      <div class="right money" data-k="sub"></div>
    `;
    const upd = ()=>{ const type=row.querySelector('[data-k=type]').value; const p=PRICE_TABLE[type]; const wash=row.querySelector('[data-k=wash]').checked; const iron=row.querySelector('[data-k=iron]').checked; const count=Number(row.querySelector('[data-k=count]').value||0); const per=(wash?p.wash:0)+(iron?p.iron:0); row.querySelector('[data-k=per]').textContent=fmt(per); row.querySelector('[data-k=sub]').textContent=fmt(per*count); recalcTotals(); };
    row.querySelectorAll('select,input').forEach(el=> el.addEventListener('input', upd));
    upd();
    return row;
  }

  function getCurrentItems(){
    return Array.from(itemsEl.children).map(row=>({
      id: row.dataset.id,
      type: row.querySelector('[data-k=type]').value,
      count: Number(row.querySelector('[data-k=count]').value||0),
      wash: row.querySelector('[data-k=wash]').checked,
      iron: row.querySelector('[data-k=iron]').checked,
    }));
  }

  function recalcTotals(){
    const items = getCurrentItems();
    const itemsTotal = calcItems(items);
    const delKey = deliverySel.value || 'Saver';
    const del = DELIVERY[delKey] || DELIVERY.Saver;
    itemsTotalEl.textContent = fmt(itemsTotal);
    deliveryCostEl.textContent = fmt(del.cost);
    grandTotalEl.textContent = fmt(itemsTotal + del.cost);
  }

  addRowBtn.onclick = ()=>{
    itemsEl.appendChild(itemRowTemplate(uid(), {type:'Shirt',count:1,wash:true,iron:false}));
  };
  // start with one row
  addRowBtn.click();

  // ---------- Wallet actions ----------
  topupBtn.onclick = ()=>{ const v=Number(topupAmt.value||0); if(v>0){ wallet.balance = +(wallet.balance + v).toFixed(2); renderWallet(); }};
  document.querySelectorAll('[data-topup]').forEach(b=> b.onclick = ()=>{ wallet.balance=+(wallet.balance + Number(b.dataset.topup)).toFixed(2); renderWallet(); });
  resetWalletBtn.onclick = ()=>{ wallet.balance=0; renderWallet(); };

  // ---------- Orders render ----------
  function itemsSummary(items){
    return items.filter(i=>i.count>0&&(i.wash||i.iron)).map(i=>{
      const tail=[i.wash?'wash':null,i.iron?'iron':null].filter(Boolean).join(', ');
      return `${i.count} ${i.type}${i.count>1?'s':''}${tail?` (${tail})`:''}`;
    }).join(', ');
  }

  function renderOrders(){
    ordersEl.innerHTML = '';
    if(!orders.length){ ordersEl.innerHTML = '<li class="small" style="color:var(--muted)">No orders yet.</li>'; return; }
    orders.forEach((o,idx)=>{
      const li=document.createElement('li');
      li.className='card';
      li.innerHTML = `
        <div class="card-b">
          <div class="flex between">
            <div class="flex" style="gap:10px"><b>Order #${o.id.slice(0,6)}</b> ${o.isCanceled?'<span class="tag">Canceled</span>':`<span class="status">${o.status}</span>`}</div>
            <div class="small" style="color:var(--muted)">Updated: ${new Date(o.updatedAt).toLocaleString()}</div>
          </div>
          <div class="grid col-2" style="margin-top:8px">
            <div class="small">Pickup: ${o.slot}</div>
            <div class="small">Payment: ${o.paymentStatus}</div>
            <div class="small">Items: ${o.summary||'—'}</div>
            <div class="small">Delivery: ${o.deliveryType} (${fmt(o.deliveryCost)})</div>
            <div class="small">Total: <b>${fmt(o.estimateMYR)}</b></div>
          </div>
          <div class="flex" style="margin-top:8px;flex-wrap:wrap">
            ${!o.isCanceled? `<button class="btn" data-prev="${o.id}">Back</button>
                              <button class="btn" data-next="${o.id}">Next</button>
                              ${o.status==='Scheduled'?`<button class="btn danger" data-cancel="${o.id}">Cancel</button>`:''}`:''}
            <button class="btn ghost" data-tl="${idx}">Timeline</button>
          </div>
          <div class="border" id="tl_${idx}" style="display:none"></div>
        </div>`;
      ordersEl.appendChild(li);
    });

    ordersEl.querySelectorAll('[data-tl]').forEach(b=> b.onclick = ()=>{
      const idx = Number(b.getAttribute('data-tl'));
      const o = orders[idx];
      const box = document.getElementById('tl_'+idx);
      if(box.style.display==='none'){ box.style.display='block'; box.innerHTML = renderTimeline(o); }
      else box.style.display='none';
    });

    ordersEl.querySelectorAll('[data-prev]').forEach(b=> b.onclick = ()=> moveStatus(b.getAttribute('data-prev'), -1));
    ordersEl.querySelectorAll('[data-next]').forEach(b=> b.onclick = ()=> moveStatus(b.getAttribute('data-next'), +1));
    ordersEl.querySelectorAll('[data-cancel]').forEach(b=> b.onclick = ()=> cancelOrder(b.getAttribute('data-cancel')));
  }

  function renderTimeline(o){
    const now = Date.now();
    const stages = ["Scheduled","Picked","Cleaning","Ready","Delivered"];
    let html = '<ol style="margin:0;padding:0 0 0 12px">';
    stages.forEach(st=>{
      const actual = (o.logs||[]).find(l=>l.status===st);
      const eatIso = o.eat? o.eat[st] : null;
      const isDone = !!actual;
      const late = !isDone && eatIso && now > new Date(eatIso).getTime();
      const left = !isDone && eatIso ? formatDuration(new Date(eatIso).getTime()-now) : null;
      const dot = isDone? 'green' : (late? 'red':'gray');
      html += `<li class="small" style="margin:6px 0">
        <span class="dot ${dot}"></span> <b>${st}</b>
        ${isDone? `<span class="small" style="color:var(--muted)">${new Date(actual.at).toLocaleString()}</span>`:''}
        ${!isDone && eatIso? `<span class="small" style="color:var(--muted)">EAT: ${new Date(eatIso).toLocaleString()}${left?` (${left})`:''}</span>`:''}
        ${late? '<span class="small" style="color:#b91c1c">Late</span>':''}
      </li>`;
    });
    html += '</ol>';
    return html;
  }

  function moveStatus(id, delta){
    const idx = orders.findIndex(o=>o.id===id); if(idx<0) return;
    const o = orders[idx]; const i = STATUSES.indexOf(o.status); const j = i+delta; if(j<0||j>=STATUSES.length) return;
    const next = STATUSES[j]; o.status = next; const t = nowIso(); o.updatedAt=t; (o.logs||(o.logs=[])).push({status:next, at:t});
    save(LS.ORDERS, orders); renderOrders();
  }
  function cancelOrder(id){
    const o = orders.find(x=>x.id===id); if(!o) return; if(!confirm('Cancel this order?')) return; o.isCanceled=true; o.updatedAt=nowIso(); (o.logs||(o.logs=[])).push({status:'Canceled', at:o.updatedAt}); save(LS.ORDERS, orders); renderOrders();
  }

  // ---------- Pricing + Place order ----------
  function recalcAndShow(){ reattachRowHandlers(); recalcTotals(); }
  function reattachRowHandlers(){ /* already attached per-row */ }
  deliverySel.addEventListener('change', recalcTotals);

  placeBtn.onclick = ()=>{
    if(!user){ alert('Save your profile first.'); return; }
    const items = getCurrentItems().filter(i=> i.count>0 && (i.wash||i.iron));
    if(items.length===0){ alert('Add at least one item.'); return; }
    const totals = { itemsTotal: calcItems(items), deliveryCost: (DELIVERY[deliverySel.value]||DELIVERY.Saver).cost };
    const grand = totals.itemsTotal + totals.deliveryCost;
    const pm = paymentSel.value;
    if(pm==='Wallet'){
      if(wallet.balance < grand){ alert('Insufficient wallet balance. Top up in Wallet.'); return; }
      wallet.balance = +(wallet.balance - grand).toFixed(2); renderWallet();
    }
    const created = nowIso();
    const order = { id:uid(), userId:user.id, lineItems:items, notes: notesEl.value.trim()||undefined, slot: slotSel.value, status:'Scheduled', createdAt:created, updatedAt:created, summary: itemsSummary(items), estimateMYR: +grand.toFixed(2), logs:[{status:'Scheduled', at:created, note:`${deliverySel.value} selected`}], deliveryType: deliverySel.value, deliveryCost: totals.deliveryCost, itemsTotal: totals.itemsTotal, paymentMethod: pm, paymentStatus: pm==='Wallet'? 'Paid (Wallet)': pm==='Online'? 'Paid (Online)':'Paid (Card)', eat: buildEat(created, deliverySel.value) };
    orders = [order, ...orders]; save(LS.ORDERS, orders); renderOrders(); alert('Order placed!');
  };

  resetFormBtn.onclick = ()=>{ itemsEl.innerHTML=''; addRowBtn.click(); notesEl.value=''; deliverySel.value='Saver'; recalcTotals(); };

  // ---------- First paint ----------
  recalcTotals(); renderOrders();
})();
</script>
</body>
</html>
