<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PressKart â€” Inâ€‘Chat App</title>
  <style>
    :root{--bg:#f7f7fb;--fg:#0f172a;--muted:#6b7280;--brand1:#f97316;--brand2:#2563eb;--card:#ffffff;--border:#e5e7eb}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    h1,h2,h3{margin:0 0 .5rem} h3{font-size:1.05rem}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .header{display:flex;align-items:center;justify-content:space-between;padding:16px 0}
    .logo{display:flex;align-items:center;gap:10px}
    .logo-badge{width:40px;height:40px;border-radius:12px;background:var(--brand1);color:white;display:grid;place-items:center;font-weight:800}
    .logo-title{line-height:1}
    .logo-title .press{color:var(--brand1);font-weight:800}
    .logo-title .kart{color:var(--brand2);font-weight:800}
    .tag{display:inline-block;background:#fee2e2;color:#b91c1c;padding:2px 8px;border-radius:999px;font-size:12px}
    .pill{display:inline-block;background:#fff3e8;color:#7c2d12;padding:3px 10px;border:1px solid #fcd9bd;border-radius:999px;font-size:12px}
    .btn{border:1px solid var(--border);background:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:#111827;color:#fff;border-color:#111827}
    .btn.ghost{background:transparent}
    .btn.danger{background:#ef4444;border-color:#ef4444;color:#fff}
    .btn.accent{background:var(--brand1);border-color:var(--brand1);color:#fff}
    .grid{display:grid;gap:16px}
    .col-2{grid-template-columns:1fr 1fr}
    .col-3{grid-template-columns:repeat(3,1fr)}
    .col-4{grid-template-columns:repeat(4,1fr)}
    @media(min-width:880px){.layout{grid-template-columns:2fr 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden}
    .card-h{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:#f3f4f6;border-bottom:1px solid var(--border)}
    .card-b{padding:16px}
    label{display:block;margin-bottom:8px;color:#374151;font-size:13px}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px}
    .row{display:grid;gap:12px}
    .row-12{grid-template-columns:3fr 1fr 2fr 2fr 1fr}
    .small{font-size:12px;color:var(--muted)}
    .flex{display:flex;gap:8px;align-items:center}
    .between{justify-content:space-between}
    .right{text-align:right}
    .nowrap{white-space:nowrap}
    .list{display:grid;gap:12px;margin:0;padding:0;list-style:none}
    .border{border-top:1px solid var(--border);margin:8px 0 0;padding-top:8px}
    .dot{width:8px;height:8px;border-radius:999px;display:inline-block}
    .green{background:#10b981}.red{background:#ef4444}.gray{background:#9ca3af}
    .status{padding:2px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px}
    .money{font-variant-numeric:tabular-nums}
    /* Tabs */
    .tabs{display:flex;gap:8px;border-bottom:1px solid var(--border);margin-bottom:10px}
    .tab{padding:8px 12px;border:1px solid var(--border);border-bottom:none;border-radius:10px 10px 0 0;background:#fff;cursor:pointer}
    .tab.active{background:#111827;color:#fff;border-color:#111827}
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="logo">
        <div class="logo-badge">PK</div>
        <div class="logo-title">
          <div><span class="press">Press</span><span class="kart">Kart</span></div>
          <div class="small">Pickup â€¢ Press â€¢ Deliver</div>
        </div>
      </div>
      <div class="flex" style="gap:10px;align-items:center">
        <div id="sessionUser" class="pill" style="display:none"></div>
        <button class="btn" id="loginBtn">Login</button>
        <button class="btn" id="logoutBtn" style="display:none">Logout</button>
        <div id="walletPill" class="pill">Wallet: RM 0.00</div>
      </div>
    </header>

    <!-- Auth Panel -->
    <section id="authSection" class="grid" style="gap:20px;display:none">
      <div class="card">
        <div class="card-h"><h3 id="authTitle">Login</h3></div>
        <div class="card-b grid col-2" id="authBody">
          <div style="grid-column:1/-1">
            <label>Email</label>
            <input id="authEmail" type="email" placeholder="you@example.com" />
          </div>
          <div style="grid-column:1/-1">
            <label>Password</label>
            <input id="authPassword" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
          </div>
          <div id="registerExtra" style="grid-column:1/-1;display:none" class="grid col-2">
            <div>
              <label>Full Name</label>
              <input id="regName" placeholder="e.g., Aina Binti Ali" />
            </div>
            <div>
              <label>Phone</label>
              <input id="regPhone" placeholder="e.g., +60 12-345 6789" />
            </div>
            <div style="grid-column:1/-1">
              <label>Address</label>
              <input id="regAddress" placeholder="Street, City" />
            </div>
          </div>
          <div style="grid-column:1/-1" class="flex between">
            <div class="small">New here? <a href="#" id="goRegister">Create an account</a></div>
            <div class="small" style="display:none" id="goLoginWrap">Already have an account? <a href="#" id="goLogin">Login</a></div>
          </div>
          <div style="grid-column:1/-1" class="flex" id="authActions">
            <button class="btn primary" id="doLogin">Login</button>
            <button class="btn" id="cancelAuth">Cancel</button>
          </div>
          <div style="grid-column:1/-1" class="flex" id="regActions" style="display:none">
            <button class="btn primary" id="doRegister">Register</button>
            <button class="btn" id="cancelReg">Cancel</button>
          </div>
        </div>
      </div>
    </section>

    <main id="appMain" class="grid layout">
      <section class="grid" style="gap:20px">
        <div class="card">
          <div class="card-h">
            <h3>Profile</h3>
            <button class="btn ghost" id="saveProfileBtn">Save</button>
          </div>
          <div class="card-b grid col-2">
            <div>
              <label>Full Name</label>
              <input id="name" placeholder="e.g., Aina Binti Ali" />
            </div>
            <div>
              <label>Phone</label>
              <input id="phone" placeholder="e.g., +60 12-345 6789" />
            </div>
            <div class="col" style="grid-column:1/-1">
              <label>Address</label>
              <input id="address" placeholder="Street, City" />
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-h between">
            <h3>Place an Order</h3>
            <span class="small">Live price + delivery</span>
          </div>
          <div class="card-b grid" style="gap:14px">
            <div>
              <label>Pickup Slot</label>
              <select id="slot"></select>
            </div>

            <div>
              <div class="flex between"><label>Laundry Items</label><button class="btn ghost" id="addRow">+ Add Item</button></div>
              <div id="items"></div>
            </div>

            <div class="grid col-3">
              <div>
                <label>Delivery Category</label>
                <select id="delivery"></select>
              </div>
              <div>
                <label>Payment</label>
                <select id="payment">
                  <option>Wallet</option>
                  <option>Online</option>
                  <option>Card</option>
                </select>
              </div>
              <div>
                <label>Notes</label>
                <input id="notes" placeholder="Gate code, fabric notes, etc." />
              </div>
            </div>

            <div>
              <div class="flex between"><span>Items total</span><b class="money" id="itemsTotal">RM 0.00</b></div>
              <div class="flex between"><span>Delivery</span><b class="money" id="deliveryCost">RM 0.00</b></div>
              <div class="flex between border"><span><b>Grand Total</b></span><span class="money" id="grandTotal"><b>RM 0.00</b></span></div>
            </div>

            <div class="flex">
              <button class="btn accent" id="placeOrder">Place Order</button>
              <button class="btn ghost" id="resetForm">Reset</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-h between">
            <h3>Your Orders</h3>
            <div class="flex" style="gap:6px">
              <button class="btn" id="tabActive">Active</button>
              <button class="btn" id="tabHistory">History</button>
            </div>
          </div>
          <div class="card-b">
            <ul id="orders" class="list"></ul>
          </div>
        </div>
      </section>

      <aside class="grid" style="gap:20px">
        <div class="card">
          <div class="card-h"><h3>Wallet</h3></div>
          <div class="card-b">
            <div class="flex between">
              <div>Balance: <b class="money" id="walletBalance">RM 0.00</b></div>
              <div class="flex">
                <input id="topupAmt" type="number" min="1" value="20" style="width:110px" />
                <button class="btn accent" id="topupBtn">Top up</button>
              </div>
            </div>
            <div class="flex" style="margin-top:8px;flex-wrap:wrap">
              <button class="btn" data-topup="10">+ RM 10</button>
              <button class="btn" data-topup="20">+ RM 20</button>
              <button class="btn" data-topup="50">+ RM 50</button>
              <button class="btn" data-topup="100">+ RM 100</button>
              <button class="btn ghost" id="resetWallet">Reset</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-h"><h3>How it works</h3></div>
          <div class="card-b small">
            <ol style="margin:0 0 0 18px;display:grid;gap:8px">
              <li>Register or login to your account.</li>
              <li>Save your profile.</li>
              <li>Add items (Wash / Iron), choose delivery.</li>
              <li>Pay (Wallet / Online / Card). Wallet deducts immediately.</li>
              <li>Track status with perâ€‘stage EAT. Delivered/Cancelled move to History.</li>
            </ol>
          </div>
        </div>
      </aside>
    </main>

    <footer class="small" style="text-align:center;color:var(--muted);padding:24px 0">Â© <span id="year"></span> PressKart (Prototype)</footer>
  </div>

<script>
(function(){
  // ---------- Constants ----------
  const ITEM_OPTIONS = ["Shirt","Pant","Bedsheet","Dress","Towel"];
  const PRICE_TABLE = {Shirt:{wash:3,iron:2},Pant:{wash:4,iron:2},Bedsheet:{wash:8,iron:5},Dress:{wash:6,iron:3},Towel:{wash:5,iron:0}};
  const DELIVERY = {Saver:{label:"Saver",cost:4,minutes:120}, Standard:{label:"Standard",cost:7,minutes:90}, Priority:{label:"Priority",cost:12,minutes:60}};
  const STATUSES = ["Scheduled","Picked","Cleaning","Ready","Delivered"];
  const WORKFLOW = {scheduled_to_picked:30, picked_to_cleaning:15, cleaning_to_ready:60};

  // ---------- Storage helpers ----------
  const LS = {USERS:'pk_users', SESSION:'pk_session_uid', WALLET_PREFIX:'pk_wallet_', ORDERS:'pk_orders'}; // orders stored globally but filtered by userId
  const load = (k, fb) => {try{const v = localStorage.getItem(k); return v? JSON.parse(v): fb;}catch{return fb}};
  const save = (k,v) => localStorage.setItem(k, JSON.stringify(v));

  // ---------- Auth state ----------
  let users = load(LS.USERS, []); // [{id,email,pass,name,phone,address}]
  let currentUserId = localStorage.getItem(LS.SESSION) || null;

  // ---------- Wallet per user ----------
  const walletKey = () => currentUserId? (LS.WALLET_PREFIX+currentUserId) : (LS.WALLET_PREFIX+'guest');
  let wallet = {balance: Number(load(walletKey(), 0)) || 0};

  // ---------- Orders (global array, filter by userId) ----------
  let orders = load(LS.ORDERS, []);

  // ---------- Utils ----------
  const uid = () => Math.random().toString(36).slice(2,10);
  const fmt = n => `RM ${Number(n||0).toFixed(2)}`;
  const nowIso = () => new Date().toISOString();
  function formatDuration(ms){ if(ms==null) return null; if(ms<=0) return '0m'; const s=Math.ceil(ms/1000); const h=Math.floor(s/3600); const m=Math.floor((s%3600)/60); const ss=s%60; if(h>0) return `${h}h ${m}m`; if(m>0) return `${m}m ${ss}s`; return `${ss}s`; }
  function buildEat(createdIso, deliveryKey){
    const base = new Date(createdIso).getTime();
    const picked = base + WORKFLOW.scheduled_to_picked*60000;
    const cleaning = picked + WORKFLOW.picked_to_cleaning*60000;
    const ready = cleaning + WORKFLOW.cleaning_to_ready*60000;
    const lastLeg = (DELIVERY[deliveryKey]||DELIVERY.Saver).minutes*60000;
    return {Picked:new Date(picked).toISOString(), Cleaning:new Date(cleaning).toISOString(), Ready:new Date(ready).toISOString(), Delivered:new Date(ready+lastLeg).toISOString()};
  }
  function calcItems(items){ let total=0; items.forEach(it=>{const p=PRICE_TABLE[it.type]; const per=(it.wash?p.wash:0)+(it.iron?p.iron:0); total += per*(it.count||0)}); return total; }

  // ---------- DOM refs ----------
  const yearEl = document.getElementById('year'); yearEl.textContent = new Date().getFullYear();
  const nameEl = document.getElementById('name');
  const phoneEl = document.getElementById('phone');
  const addressEl = document.getElementById('address');
  const saveProfileBtn = document.getElementById('saveProfileBtn');
  const walletPill = document.getElementById('walletPill');
  const walletBal = document.getElementById('walletBalance');
  const topupAmt = document.getElementById('topupAmt');
  const topupBtn = document.getElementById('topupBtn');
  const resetWalletBtn = document.getElementById('resetWallet');
  const slotSel = document.getElementById('slot');
  const itemsEl = document.getElementById('items');
  const addRowBtn = document.getElementById('addRow');
  const deliverySel = document.getElementById('delivery');
  const paymentSel = document.getElementById('payment');
  const notesEl = document.getElementById('notes');
  const itemsTotalEl = document.getElementById('itemsTotal');
  const deliveryCostEl = document.getElementById('deliveryCost');
  const grandTotalEl = document.getElementById('grandTotal');
  const placeBtn = document.getElementById('placeOrder');
  const resetFormBtn = document.getElementById('resetForm');
  const ordersEl = document.getElementById('orders');
  const tabActiveBtn = document.getElementById('tabActive');
  const tabHistoryBtn = document.getElementById('tabHistory');

  // Auth UI
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const sessionUser = document.getElementById('sessionUser');
  const authSection = document.getElementById('authSection');
  const appMain = document.getElementById('appMain');
  const authTitle = document.getElementById('authTitle');
  const authEmail = document.getElementById('authEmail');
  const authPassword = document.getElementById('authPassword');
  const goRegister = document.getElementById('goRegister');
  const goLogin = document.getElementById('goLogin');
  const goLoginWrap = document.getElementById('goLoginWrap');
  const registerExtra = document.getElementById('registerExtra');
  const doLogin = document.getElementById('doLogin');
  const cancelAuth = document.getElementById('cancelAuth');
  const doRegister = document.getElementById('doRegister');
  const cancelReg = document.getElementById('cancelReg');
  const regName = document.getElementById('regName');
  const regPhone = document.getElementById('regPhone');
  const regAddress = document.getElementById('regAddress');

  function setAuthMode(mode){
    if(mode==='login'){
      authTitle.textContent='Login'; registerExtra.style.display='none'; doLogin.style.display='inline-block'; cancelAuth.style.display='inline-block'; doRegister.style.display='none'; goLoginWrap.style.display='none';
    } else {
      authTitle.textContent='Register'; registerExtra.style.display='grid'; doLogin.style.display='none'; cancelAuth.style.display='none'; doRegister.style.display='inline-block'; goLoginWrap.style.display='block';
    }
  }

  function showAuth(show){ authSection.style.display = show? 'block':'none'; appMain.style.display = show? 'none':'grid'; }

  function currentUser(){ return users.find(u=>u.id===currentUserId)||null; }

  function refreshSessionUI(){
    const u = currentUser();
    if(u){
      sessionUser.style.display='inline-block'; sessionUser.textContent = `ðŸ‘¤ ${u.name||u.email}`; loginBtn.style.display='none'; logoutBtn.style.display='inline-block';
      // load profile fields
      nameEl.value = u.name||''; phoneEl.value=u.phone||''; addressEl.value=u.address||'';
    } else {
      sessionUser.style.display='none'; loginBtn.style.display='inline-block'; logoutBtn.style.display='none';
      nameEl.value = phoneEl.value = addressEl.value = '';
    }
    // wallet for this user
    wallet = {balance: Number(load(walletKey(), 0)) || 0};
    renderWallet();
    // render orders filtered by user
    renderOrders();
  }

  loginBtn.onclick = ()=>{ setAuthMode('login'); showAuth(true); };
  logoutBtn.onclick = ()=>{ currentUserId=null; localStorage.removeItem(LS.SESSION); refreshSessionUI(); alert('Logged out'); };
  cancelAuth.onclick = ()=>{ showAuth(false); };
  cancelReg.onclick = ()=>{ setAuthMode('login'); };
  goRegister.onclick = (e)=>{ e.preventDefault(); setAuthMode('register'); goRegister.parentElement.style.display='none'; };
  goLogin.onclick = (e)=>{ e.preventDefault(); setAuthMode('login'); goRegister.parentElement.style.display='block'; };

  doLogin.onclick = ()=>{
    const email = authEmail.value.trim().toLowerCase(); const pass = authPassword.value;
    const u = users.find(x=>x.email===email && x.pass===pass);
    if(!u){ alert('Invalid email or password'); return; }
    currentUserId = u.id; localStorage.setItem(LS.SESSION, currentUserId); showAuth(false); refreshSessionUI();
  };

  doRegister.onclick = ()=>{
    const email = authEmail.value.trim().toLowerCase(); const pass = authPassword.value;
    if(!email || !/^[^@]+@[^@]+\.[^@]+$/.test(email)) return alert('Enter a valid email');
    if(!pass || pass.length<6) return alert('Password must be at least 6 characters');
    if(users.some(u=>u.email===email)) return alert('Email already registered');
    const name = regName.value.trim(); const phone = regPhone.value.trim(); const address = regAddress.value.trim();
    const u = {id:uid(), email, pass, name, phone, address}; users=[...users,u]; save(LS.USERS, users);
    currentUserId = u.id; localStorage.setItem(LS.SESSION, currentUserId);
    showAuth(false); refreshSessionUI(); alert('Account created!');
  };

  // ---------- Profile & Wallet ----------
  function renderWallet(){ walletPill.textContent = `Wallet: ${fmt(wallet.balance)}`; walletBal.textContent = fmt(wallet.balance); save(walletKey(), wallet.balance); }
  function renderProfile(){ const u=currentUser(); if(u){ nameEl.value=u.name||''; phoneEl.value=u.phone||''; addressEl.value=u.address||''; } }
  renderProfile(); renderWallet();

  saveProfileBtn.onclick = () => {
    const u=currentUser(); if(!u){ alert('Please login first.'); return; }
    const name = nameEl.value.trim(), phone = phoneEl.value.trim(), address = addressEl.value.trim();
    if(!name||!phone||!address){ alert('Please fill all fields.'); return; }
    Object.assign(u,{name,phone,address}); users = users.map(x=> x.id===u.id? u:x); save(LS.USERS, users); alert('Profile saved');
    // seed a demo order once per user
    if(!orders.some(o=>o.userId===u.id)){
      const created = nowIso();
      const demo = { id: uid(), userId:u.id, lineItems:[{id:uid(),type:'Shirt',count:3,wash:true,iron:false}], notes:'Ring bell', slot: new Date().toISOString().slice(0,10)+" 12:00â€“14:00", status:'Scheduled', createdAt:created, updatedAt:created, summary:'3 Shirts (wash)', itemsTotal:9, deliveryType:'Saver', deliveryCost:4, estimateMYR:13, logs:[{status:'Scheduled',at:created}], paymentMethod:'Wallet', paymentStatus:'Paid (Wallet)', eat: buildEat(created,'Saver') };
      orders=[demo, ...orders]; save(LS.ORDERS, orders); renderOrders();
    }
  };

  // ---------- Slots & Delivery ----------
  (function buildSlots(){ const out=[]; const base=new Date(); for(let d=0; d<3; d++){ const day=new Date(base); day.setDate(base.getDate()+d); const ds=day.toISOString().slice(0,10); ["10:00â€“12:00","12:00â€“14:00","16:00â€“18:00"].forEach(r=>out.push(`${ds} ${r}`)); } out.forEach(s=>{ const o=document.createElement('option'); o.textContent=s; slotSel.appendChild(o); }); })();
  (function buildDelivery(){ Object.keys(DELIVERY).forEach(k=>{ const opt=document.createElement('option'); const v=DELIVERY[k]; opt.value=k; opt.textContent=`${v.label} â€” ${fmt(v.cost)} / ~${(v.minutes/60).toFixed(2)}h`; deliverySel.appendChild(opt); }); })();

  // ---------- Items UI ----------
  function itemRowTemplate(id, def){
    const row=document.createElement('div'); row.className='row row-12'; row.dataset.id=id;
    row.innerHTML = `
      <div>
        <select name="type" data-k="type">${ITEM_OPTIONS.map(o=>`<option ${def.type===o?'selected':''}>${o}</option>`).join('')}</select>
      </div>
      <div><input type="number" min="0" value="${def.count}" data-k="count"/></div>
      <div class="flex" style="gap:12px">
        <label class="flex"><input type="checkbox" ${def.wash?'checked':''} data-k="wash"/> <span class="small" style="margin-left:6px">Wash</span></label>
        <label class="flex"><input type="checkbox" ${def.iron?'checked':''} data-k="iron"/> <span class="small" style="margin-left:6px">Iron</span></label>
      </div>
      <div class="right nowrap small">Perâ€‘unit: <span class="money" data-k="per"></span> <span class="small">/ unit</span></div>
      <div class="right money" data-k="sub"></div>
    `;
    const upd = ()=>{ const type=row.querySelector('[data-k=type]').value; const p=PRICE_TABLE[type]; const wash=row.querySelector('[data-k=wash]').checked; const iron=row.querySelector('[data-k=iron]').checked; const count=Number(row.querySelector('[data-k=count]').value||0); const per=(wash?p.wash:0)+(iron?p.iron:0); row.querySelector('[data-k=per]').textContent=fmt(per); row.querySelector('[data-k=sub]').textContent=fmt(per*count); recalcTotals(); };
    row.querySelectorAll('select,input').forEach(el=> el.addEventListener('input', upd));
    upd();
    return row;
  }

  function getCurrentItems(){
    return Array.from(itemsEl.children).map(row=>({ id: row.dataset.id, type: row.querySelector('[data-k=type]').value, count: Number(row.querySelector('[data-k=count]').value||0), wash: row.querySelector('[data-k=wash]').checked, iron: row.querySelector('[data-k=iron]').checked }));
  }

  function recalcTotals(){
    const items = getCurrentItems();
    const itemsTotal = calcItems(items);
    const delKey = deliverySel.value || 'Saver';
    const del = DELIVERY[delKey] || DELIVERY.Saver;
    itemsTotalEl.textContent = fmt(itemsTotal);
    deliveryCostEl.textContent = fmt(del.cost);
    grandTotalEl.textContent = fmt(itemsTotal + del.cost);
  }

  addRowBtn.onclick = ()=>{ itemsEl.appendChild(itemRowTemplate(uid(), {type:'Shirt',count:1,wash:true,iron:false})); };
  // start with one row
  addRowBtn.click();

  // ---------- Wallet actions ----------
  topupBtn.onclick = ()=>{ const v=Number(topupAmt.value||0); if(v>0){ wallet.balance = +(wallet.balance + v).toFixed(2); renderWallet(); }};
  document.querySelectorAll('[data-topup]').forEach(b=> b.onclick = ()=>{ wallet.balance=+(wallet.balance + Number(b.dataset.topup)).toFixed(2); renderWallet(); });
  resetWalletBtn.onclick = ()=>{ wallet.balance=0; renderWallet(); };

  // ---------- Orders ----------
  function itemsSummary(items){
    return items.filter(i=>i.count>0&&(i.wash||i.iron)).map(i=>{ const tail=[i.wash?'wash':null,i.iron?'iron':null].filter(Boolean).join(', '); return `${i.count} ${i.type}${i.count>1?'s':''}${tail?` (${tail})`:''}`; }).join(', ');
  }

  function isHistoryOrder(o){ return o.isCanceled || o.status==='Delivered'; }

  function renderOrders(view='active'){
    ordersEl.innerHTML = '';
    const u = currentUser();
    const myOrders = orders.filter(o=> u? o.userId===u.id : false);
    const list = view==='active' ? myOrders.filter(o=> !isHistoryOrder(o)) : myOrders.filter(isHistoryOrder);
    if(!list.length){ ordersEl.innerHTML = `<li class="small" style="color:var(--muted)">${view==='active'?'No active orders.':'No history yet.'}</li>`; return; }
    list.forEach((o,idx)=>{
      const li=document.createElement('li'); li.className='card';
      li.innerHTML = `
        <div class="card-b">
          <div class="flex between">
            <div class="flex" style="gap:10px"><b>Order #${o.id.slice(0,6)}</b> ${o.isCanceled?'<span class="tag">Canceled</span>':`<span class="status">${o.status}</span>`}</div>
            <div class="small" style="color:var(--muted)">Updated: ${new Date(o.updatedAt).toLocaleString()}</div>
          </div>
          <div class="grid col-2" style="margin-top:8px">
            <div class="small">Pickup: ${o.slot}</div>
            <div class="small">Payment: ${o.paymentStatus}</div>
            <div class="small">Items: ${o.summary||'â€”'}</div>
            <div class="small">Delivery: ${o.deliveryType} (${fmt(o.deliveryCost)})</div>
            <div class="small">Total: <b>${fmt(o.estimateMYR)}</b></div>
          </div>
          <div class="flex" style="margin-top:8px;flex-wrap:wrap">
            ${(!o.isCanceled && o.status!=='Delivered' && view==='active')? `<button class="btn" data-prev="${o.id}">Back</button>
                              <button class="btn" data-next="${o.id}">Next</button>
                              ${o.status==='Scheduled'?`<button class="btn danger" data-cancel="${o.id}">Cancel</button>`:''}`:''}
            <button class="btn ghost" data-tl="${o.id}">Timeline</button>
          </div>
          <div class="border" id="tl_${o.id}" style="display:none"></div>
        </div>`;
      ordersEl.appendChild(li);
    });

    ordersEl.querySelectorAll('[data-tl]').forEach(b=> b.onclick = ()=>{
      const id = b.getAttribute('data-tl');
      const o = orders.find(x=>x.id===id);
      const box = document.getElementById('tl_'+id);
      if(!o||!box) return;
      if(box.style.display==='none'){ box.style.display='block'; box.innerHTML = renderTimeline(o); }
      else box.style.display='none';
    });

    ordersEl.querySelectorAll('[data-prev]').forEach(b=> b.onclick = ()=> moveStatus(b.getAttribute('data-prev'), -1));
    ordersEl.querySelectorAll('[data-next]').forEach(b=> b.onclick = ()=> moveStatus(b.getAttribute('data-next'), +1));
    ordersEl.querySelectorAll('[data-cancel]').forEach(b=> b.onclick = ()=> cancelOrder(b.getAttribute('data-cancel')));
  }

  tabActiveBtn.onclick = ()=>{ tabActiveBtn.classList.add('primary'); tabHistoryBtn.classList.remove('primary'); renderOrders('active'); };
  tabHistoryBtn.onclick = ()=>{ tabHistoryBtn.classList.add('primary'); tabActiveBtn.classList.remove('primary'); renderOrders('history'); };

  function renderTimeline(o){
    const now = Date.now();
    const stages = ["Scheduled","Picked","Cleaning","Ready","Delivered"];
    let html = '<ol style="margin:0;padding:0 0 0 12px">';
    stages.forEach(st=>{
      const actual = (o.logs||[]).find(l=>l.status===st);
      const eatIso = o.eat? o.eat[st] : null;
      const isDone = !!actual;
      const late = !isDone && eatIso && now > new Date(eatIso).getTime();
      const left = !isDone && eatIso ? formatDuration(new Date(eatIso).getTime()-now) : null;
      const dot = isDone? 'green' : (late? 'red':'gray');
      html += `<li class="small" style="margin:6px 0">
        <span class="dot ${dot}"></span> <b>${st}</b>
        ${isDone? `<span class="small" style="color:var(--muted)">${new Date(actual.at).toLocaleString()}</span>`:''}
        ${!isDone && eatIso? `<span class="small" style="color:var(--muted)">EAT: ${new Date(eatIso).toLocaleString()}${left?` (${left})`:''}</span>`:''}
        ${late? '<span class="small" style="color:#b91c1c">Late</span>':''}
      </li>`;
    });
    html += '</ol>';
    return html;
  }

  function moveStatus(id, delta){
    const idx = orders.findIndex(o=>o.id===id); if(idx<0) return;
    const o = orders[idx]; const i = STATUSES.indexOf(o.status); const j = i+delta; if(j<0||j>=STATUSES.length) return;
    const next = STATUSES[j]; o.status = next; const t = nowIso(); o.updatedAt=t; (o.logs||(o.logs=[])).push({status:next, at:t});
    save(LS.ORDERS, orders); // rerender according to current tab
    if(tabHistoryBtn.classList.contains('primary')) renderOrders('history'); else renderOrders('active');
  }
  function cancelOrder(id){
    const o = orders.find(x=>x.id===id); if(!o) return; if(!confirm('Cancel this order?')) return; o.isCanceled=true; o.updatedAt=nowIso(); (o.logs||(o.logs=[])).push({status:'Canceled', at:o.updatedAt}); save(LS.ORDERS, orders); if(tabHistoryBtn.classList.contains('primary')) renderOrders('history'); else renderOrders('active');
  }

  // ---------- Pricing + Place order ----------
  function recalcAndShow(){ reattachRowHandlers(); recalcTotals(); }
  function reattachRowHandlers(){ /* already attached per-row */ }
  deliverySel.addEventListener('change', recalcTotals);

  placeBtn.onclick = ()=>{
    const u=currentUser(); if(!u){ alert('Please login first.'); return; }
    const items = getCurrentItems().filter(i=> i.count>0 && (i.wash||i.iron));
    if(items.length===0){ alert('Add at least one item.'); return; }
    const totals = { itemsTotal: calcItems(items), deliveryCost: (DELIVERY[deliverySel.value]||DELIVERY.Saver).cost };
    const grand = totals.itemsTotal + totals.deliveryCost;
    const pm = paymentSel.value;
    if(pm==='Wallet'){
      if(wallet.balance < grand){ alert('Insufficient wallet balance. Top up in Wallet.'); return; }
      wallet.balance = +(wallet.balance - grand).toFixed(2); renderWallet();
    }
    const created = nowIso();
    const order = { id:uid(), userId:u.id, lineItems:items, notes: notesEl.value.trim()||undefined, slot: slotSel.value, status:'Scheduled', createdAt:created, updatedAt:created, summary: itemsSummary(items), estimateMYR: +grand.toFixed(2), logs:[{status:'Scheduled', at:created, note:`${deliverySel.value} selected`}], deliveryType: deliverySel.value, deliveryCost: totals.deliveryCost, itemsTotal: totals.itemsTotal, paymentMethod: pm, paymentStatus: pm==='Wallet'? 'Paid (Wallet)': pm==='Online'? 'Paid (Online)':'Paid (Card)', eat: buildEat(created, deliverySel.value) };
    orders = [order, ...orders]; save(LS.ORDERS, orders); alert('Order placed!');
    // After placing, switch to Active and re-render
    tabActiveBtn.classList.add('primary'); tabHistoryBtn.classList.remove('primary'); renderOrders('active');
  };

  resetFormBtn.onclick = ()=>{ itemsEl.innerHTML=''; addRowBtn.click(); notesEl.value=''; deliverySel.value='Saver'; recalcTotals(); };

  // ---------- First paint ----------
  function firstPaint(){ tabActiveBtn.classList.add('primary'); renderOrders('active'); refreshSessionUI(); }
  firstPaint();
})();
</script>
</body>
</html>
